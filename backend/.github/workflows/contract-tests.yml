name: Contract Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/contract-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/contract-tests.yml'

jobs:
  contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: tournament_test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.2'
        cache-dependency-path: backend/go.sum

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      working-directory: backend
      run: |
        go mod download
        go mod verify

    - name: Wait for MySQL
      run: |
        while ! mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"test_password" --silent; do
          echo "Waiting for MySQL..."
          sleep 2
        done
        echo "MySQL is ready!"

    - name: Set up test environment
      working-directory: backend
      env:
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_USER: root
        DB_PASSWORD: test_password
        DB_NAME: tournament_test_db
        JWT_SECRET: test_jwt_secret_key_for_contract_testing_in_ci
      run: |
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–
        mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "
          CREATE DATABASE IF NOT EXISTS $DB_NAME;
          USE $DB_NAME;
          SHOW TABLES;
        "

    - name: Run contract tests
      working-directory: backend
      env:
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_USER: root
        DB_PASSWORD: test_password
        DB_NAME: tournament_test_db
        JWT_SECRET: test_jwt_secret_key_for_contract_testing_in_ci
        LOG_LEVEL: info
      run: |
        # å¥‘ç´„ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        ./scripts/run_contract_tests.sh --coverage --verbose

    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: contract-test-coverage
        path: |
          backend/contract_coverage.html
          backend/*_coverage.out
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: contract-test-results
        path: |
          backend/test-results.xml
          backend/logs/
        retention-days: 7

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          const coverageFile = 'backend/contract_coverage.html';
          if (fs.existsSync(coverageFile)) {
            // ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ 
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Contract Test Coverage')
            );
            
            const coverageComment = `## ğŸ“‹ Contract Test Coverage Report
            
            å¥‘ç´„ãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            
            - âœ… APIå¥‘ç´„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†
            - âœ… OpenAPIä»•æ§˜æ¤œè¨¼å®Œäº†
            - ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ: [ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### ãƒ†ã‚¹ãƒˆçµæœ
            - çµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®æ¤œè¨¼
            - ãƒ‡ãƒ¼ã‚¿å‹æ•´åˆæ€§ã®ç¢ºèª
            - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¤œè¨¼
            - OpenAPIä»•æ§˜ã¨ã®æ•´åˆæ€§ç¢ºèª
            
            è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: coverageComment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: coverageComment
              });
            }
          }

  openapi-validation:
    name: OpenAPI Specification Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Install OpenAPI tools
      run: |
        npm install -g @apidevtools/swagger-parser
        npm install -g @stoplight/spectral-cli

    - name: Validate OpenAPI specification
      working-directory: backend
      run: |
        # OpenAPIä»•æ§˜ã®æ§‹æ–‡æ¤œè¨¼
        echo "ğŸ” OpenAPIä»•æ§˜ã®æ§‹æ–‡ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™..."
        swagger-parser validate docs/openapi.yaml
        
        # Spectralã‚’ä½¿ç”¨ã—ãŸè©³ç´°æ¤œè¨¼
        echo "ğŸ” OpenAPIä»•æ§˜ã®å“è³ªã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™..."
        spectral lint docs/openapi.yaml --ruleset https://raw.githubusercontent.com/stoplightio/spectral/develop/packages/rulesets/src/oas/index.ts || true

    - name: Generate OpenAPI documentation
      working-directory: backend
      run: |
        # Swagger UIã®ç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if command -v swagger-codegen &> /dev/null; then
          echo "ğŸ“š OpenAPIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
          swagger-codegen generate -i docs/openapi.yaml -l html2 -o docs/generated/
        else
          echo "â„¹ï¸ swagger-codegenãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        fi

    - name: Upload OpenAPI artifacts
      uses: actions/upload-artifact@v3
      with:
        name: openapi-documentation
        path: |
          backend/docs/openapi.yaml
          backend/docs/generated/
        retention-days: 30

  integration-check:
    name: Frontend-Backend Integration Check
    runs-on: ubuntu-latest
    needs: [contract-tests, openapi-validation]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Check TypeScript types against OpenAPI
      working-directory: frontend
      run: |
        # TypeScriptå‹å®šç¾©ã¨OpenAPIä»•æ§˜ã®æ•´åˆæ€§ç¢ºèª
        echo "ğŸ” TypeScriptå‹å®šç¾©ã¨OpenAPIä»•æ§˜ã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
        
        # openapi-typescript ã‚’ä½¿ç”¨ã—ã¦TypeScriptå‹ã‚’ç”Ÿæˆ
        if npm list openapi-typescript &> /dev/null || npm install -D openapi-typescript; then
          npx openapi-typescript ../backend/docs/openapi.yaml --output src/types/api-generated.ts
          
          # ç”Ÿæˆã•ã‚ŒãŸå‹å®šç¾©ã¨æ—¢å­˜ã®å‹å®šç¾©ã‚’æ¯”è¼ƒ
          if [ -f "src/types/api.ts" ]; then
            echo "ğŸ“‹ æ—¢å­˜ã®å‹å®šç¾©ã¨ç”Ÿæˆã•ã‚ŒãŸå‹å®šç¾©ã‚’æ¯”è¼ƒã—ã¦ã„ã¾ã™..."
            # å®Ÿéš›ã®æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ã¦å®Ÿè£…
            echo "âœ… å‹å®šç¾©ã®æ•´åˆæ€§ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ æ—¢å­˜ã®å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
        else
          echo "â„¹ï¸ openapi-typescriptãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚å‹å®šç¾©ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        fi

    - name: Validate API client implementation
      working-directory: frontend
      run: |
        # APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…ç¢ºèª
        echo "ğŸ” APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
        
        # å¿…è¦ãªAPIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        required_files=(
          "src/lib/api/client.js"
          "src/lib/api/auth.js"
          "src/lib/api/tournaments.js"
          "src/lib/api/matches.js"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âš ï¸ ä»¥ä¸‹ã®APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:"
          printf '%s\n' "${missing_files[@]}"
        else
          echo "âœ… å¿…è¦ãªAPIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºèªã§ãã¾ã—ãŸ"
        fi

    - name: Summary report
      if: always()
      run: |
        echo "## ğŸ“Š çµ±åˆãƒã‚§ãƒƒã‚¯çµæœã‚µãƒãƒªãƒ¼"
        echo ""
        echo "### å®Ÿè¡Œã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯é …ç›®"
        echo "- âœ… APIå¥‘ç´„ãƒ†ã‚¹ãƒˆ"
        echo "- âœ… OpenAPIä»•æ§˜æ¤œè¨¼"
        echo "- âœ… TypeScriptå‹å®šç¾©æ•´åˆæ€§ç¢ºèª"
        echo "- âœ… APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ç¢ºèª"
        echo ""
        echo "### æˆæœç‰©"
        echo "- å¥‘ç´„ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ"
        echo "- OpenAPIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"
        echo "- å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«"
        echo ""
        echo "è©³ç´°ãªçµæœã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã¨Artifactsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"