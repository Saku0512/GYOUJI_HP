import{redirect as e}from"@sveltejs/kit";import{g as t}from"./index.js";import{a as r,g as n}from"./auth.js";function o(e){if(!e)return!0;try{const t=JSON.parse(atob(e.split(".")[1])),r=Math.floor(Date.now()/1e3),n=300;return t.exp<r+n}catch(t){return!0}}async function c(c,i={}){const a=await async function(t,c={}){const{redirectTo:i="/login",allowExpired:a=!1,checkServer:s=!0}=c;if("undefined"==typeof window)return{authenticated:!1};const d=n();if(!d){const r=`${i}?redirect=${encodeURIComponent(t.pathname+t.search)}`;throw e(302,r)}if(!a&&o(d))try{if(!(await r.refreshToken()).success){const r=`${i}?expired=true&redirect=${encodeURIComponent(t.pathname+t.search)}`;throw e(302,r)}}catch(u){const r=`${i}?expired=true&redirect=${encodeURIComponent(t.pathname+t.search)}`;throw e(302,r)}if(s)try{if(!(await r.checkAuthStatus()).success){const r=`${i}?invalid=true&redirect=${encodeURIComponent(t.pathname+t.search)}`;throw e(302,r)}}catch(u){const r=`${i}?error=true&redirect=${encodeURIComponent(t.pathname+t.search)}`;throw e(302,r)}return{authenticated:!0}}(c,i);if(!a.authenticated)return a;const s=t(r).user;if(!s||"admin"!==s.role)throw e(302,"/login?unauthorized=true");return{authenticated:!0,isAdmin:!0}}function i(t,r={}){const{redirectTo:c="/admin",checkExpired:i=!0}=r;if("undefined"==typeof window)return{shouldRedirect:!1};const a=n();if(a&&(!i||!o(a))){const r=t.searchParams.get("redirect")||c;throw e(302,r)}return{shouldRedirect:!1}}async function a(e="/login"){try{await r.logout(),"undefined"!=typeof window&&(window.location.href=e)}catch(t){"undefined"!=typeof window&&(window.location.href=e+"?logout_error=true")}}export{i as a,a as p,c as r};
