import{w as t,T as e,p as s,x as i,o as a,z as n,B as r,g as o,A as l,i as c,H as h,I as u,Y as g,c as m,d as p,Z as y,m as d,q as b,_ as f,a0 as w,a1 as C,C as v,U as L}from"./BRFgxvOq.js";import{u as T,t as I,m as S}from"./DiqqC9HZ.js";import"./Cm9PB-7n.js";import"./BB0NFQV6.js";const E=new class{constructor(t={}){this.options={interval:3e4,maxRetries:3,retryDelay:5e3,exponentialBackoff:!0,respectVisibility:!0,enableLogging:!0,...t},this.intervalId=null,this.isPolling=!1,this.retryCount=0,this.lastSuccessTime=null,this.lastErrorTime=null,this.callbacks=new Map,this.errorCallbacks=new Map,this.isPageVisible=!document.hidden,this.setupVisibilityListener(),this.isOnline=navigator.onLine,this.setupNetworkListener()}setupVisibilityListener(){"undefined"!=typeof document&&document.addEventListener("visibilitychange",()=>{this.isPageVisible=!document.hidden,this.options.enableLogging,this.isPageVisible&&this.isPolling&&this.executePoll()})}setupNetworkListener(){"undefined"!=typeof window&&(window.addEventListener("online",()=>{this.isOnline=!0,this.options.enableLogging,this.isPolling&&this.executePoll()}),window.addEventListener("offline",()=>{this.isOnline=!1,this.options.enableLogging}))}registerCallback(t,e){if("function"!=typeof e)throw new Error("Callback must be a function");this.callbacks.set(t,e),this.options.enableLogging}registerErrorCallback(t,e){if("function"!=typeof e)throw new Error("Error callback must be a function");this.errorCallbacks.set(t,e),this.options.enableLogging}unregisterCallback(t){const e=this.callbacks.delete(t);return this.options.enableLogging,e}unregisterErrorCallback(t){const e=this.errorCallbacks.delete(t);return this.options.enableLogging,e}start(){this.isPolling?this.options.enableLogging:(this.isPolling=!0,this.retryCount=0,this.options.enableLogging,this.intervalId=setInterval(()=>{this.executePoll()},this.options.interval))}stop(){this.isPolling&&(this.isPolling=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.options.enableLogging)}pause(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.options.enableLogging}resume(){this.isPolling&&!this.intervalId&&(this.intervalId=setInterval(()=>{this.executePoll()},this.options.interval),this.options.enableLogging)}async executePoll(){if(this.isPolling)if(!this.options.respectVisibility||this.isPageVisible)if(this.isOnline)try{this.options.enableLogging;const e=Array.from(this.callbacks.entries()).map(async([t,e])=>{try{return await e(),{key:t,success:!0}}catch(s){return{key:t,success:!1,error:s}}}),s=await Promise.allSettled(e);let i=!1;for(const a of s)if("fulfilled"===a.status&&!a.value.success){i=!0;const e=this.errorCallbacks.get(a.value.key);if(e)try{await e(a.value.error)}catch(t){}}if(i)throw new Error("One or more polling callbacks failed");this.onPollSuccess()}catch(e){this.onPollError(e)}else this.options.enableLogging;else this.options.enableLogging}onPollSuccess(){this.lastSuccessTime=Date.now(),this.retryCount=0,this.options.enableLogging}async onPollError(t){if(this.lastErrorTime=Date.now(),this.retryCount++,this.retryCount>=this.options.maxRetries)return T.showNotification("データの更新に失敗しました。ネットワーク接続を確認してください。","error",1e4),void(this.retryCount=0);const e=this.calculateRetryDelay();this.options.enableLogging,setTimeout(()=>{this.isPolling&&this.executePoll()},e)}calculateRetryDelay(){if(!this.options.exponentialBackoff)return this.options.retryDelay;const t=this.options.retryDelay*Math.pow(2,this.retryCount-1);return Math.min(t,6e4)}setInterval(t){if("number"!=typeof t||t<1e3)throw new Error("Interval must be a number >= 1000ms");this.options.interval=t,this.isPolling&&(this.pause(),this.resume()),this.options.enableLogging}getStats(){return{isPolling:this.isPolling,isPageVisible:this.isPageVisible,isOnline:this.isOnline,interval:this.options.interval,retryCount:this.retryCount,lastSuccessTime:this.lastSuccessTime,lastErrorTime:this.lastErrorTime,callbackCount:this.callbacks.size,errorCallbackCount:this.errorCallbacks.size}}destroy(){this.stop(),this.callbacks.clear(),this.errorCallbacks.clear(),this.options.enableLogging}}({interval:3e4,maxRetries:3,retryDelay:5e3,exponentialBackoff:!0,respectVisibility:!0,enableLogging:!1});class k{constructor(t,e={}){this.data=t,this.timestamp=Date.now(),this.ttl=e.ttl||3e5,this.tags=e.tags||[],this.priority=e.priority||1,this.accessCount=0,this.lastAccessed=this.timestamp}isValid(){return Date.now()-this.timestamp<this.ttl}access(){return this.accessCount++,this.lastAccessed=Date.now(),this.data}getRemainingTTL(){const t=this.ttl-(Date.now()-this.timestamp);return Math.max(0,t)}}class R{constructor(t={}){this.options={maxSize:100,defaultTTL:3e5,cleanupInterval:6e4,enableLogging:!1,...t},this.cache=new Map,this.stats={hits:0,misses:0,sets:0,deletes:0,evictions:0},this.startCleanup()}set(t,e,s={}){if(!t)throw new Error("Cache key is required");const i=s.ttl||this.options.defaultTTL,a=new k(e,{ttl:i,tags:s.tags,priority:s.priority});return this.cache.size>=this.options.maxSize&&!this.cache.has(t)&&this.evictLRU(),this.cache.set(t,a),this.stats.sets++,this.options.enableLogging,!0}get(t){if(!t)return null;const e=this.cache.get(t);return e?e.isValid()?(this.stats.hits++,this.options.enableLogging,e.access()):(this.cache.delete(t),this.stats.misses++,this.options.enableLogging,null):(this.stats.misses++,null)}delete(t){const e=this.cache.delete(t);return e&&(this.stats.deletes++,this.options.enableLogging),e}invalidateByTag(t){const e=Array.isArray(t)?t:[t];let s=0;for(const[i,a]of this.cache.entries())a.tags&&a.tags.some(t=>e.includes(t))&&(this.cache.delete(i),s++);return this.options.enableLogging,s}clear(){const t=this.cache.size;return this.cache.clear(),this.options.enableLogging,t}evictLRU(){let t=null,e=Date.now();for(const[s,i]of this.cache.entries())i.lastAccessed<=e&&(e=i.lastAccessed,t=s);t&&(this.cache.delete(t),this.stats.evictions++,this.options.enableLogging)}cleanup(){let t=0;for(const[e,s]of this.cache.entries())s.isValid()||(this.cache.delete(e),t++);return this.options.enableLogging,t}startCleanup(){this.cleanupInterval&&clearInterval(this.cleanupInterval),this.cleanupInterval=setInterval(()=>{this.cleanup()},this.options.cleanupInterval)}stopCleanup(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}getStats(){const t=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(2):0;return{...this.stats,size:this.cache.size,maxSize:this.options.maxSize,hitRate:`${t}%`}}getInfo(){const t=[];for(const[e,s]of this.cache.entries())t.push({key:e,size:JSON.stringify(s.data).length,ttl:s.ttl,remainingTTL:s.getRemainingTTL(),accessCount:s.accessCount,lastAccessed:s.lastAccessed,tags:s.tags,priority:s.priority,isValid:s.isValid()});return{entries:t,stats:this.getStats(),options:this.options}}destroy(){this.stopCleanup(),this.clear()}}class P{constructor(t={}){this.options={storage:"localStorage",prefix:"cache_",defaultTTL:36e5,enableLogging:!1,...t},this.storage="sessionStorage"===this.options.storage?sessionStorage:localStorage}getStorageKey(t){return`${this.options.prefix}${t}`}set(t,e,s={}){if(!t)throw new Error("Cache key is required");try{const i=s.ttl||this.options.defaultTTL,a={data:e,timestamp:Date.now(),ttl:i},n=this.getStorageKey(t);return this.storage.setItem(n,JSON.stringify(a)),this.options.enableLogging,!0}catch(i){return!1}}get(t){if(!t)return null;try{const e=this.getStorageKey(t),s=this.storage.getItem(e);if(!s)return null;const i=JSON.parse(s);return Date.now()-i.timestamp>i.ttl?(this.storage.removeItem(e),this.options.enableLogging,null):(this.options.enableLogging,i.data)}catch(e){return null}}delete(t){try{const e=this.getStorageKey(t);return this.storage.removeItem(e),this.options.enableLogging,!0}catch(e){return!1}}clear(){try{const t=[];for(let e=0;e<this.storage.length;e++){const s=this.storage.key(e);s&&s.startsWith(this.options.prefix)&&t.push(s)}return t.forEach(t=>{this.storage.removeItem(t)}),this.options.enableLogging,t.length}catch(t){return 0}}cleanup(){try{const e=[];for(let s=0;s<this.storage.length;s++){const i=this.storage.key(s);if(i&&i.startsWith(this.options.prefix))try{const t=this.storage.getItem(i);if(t){const s=JSON.parse(t);Date.now()-s.timestamp>s.ttl&&e.push(i)}}catch(t){e.push(i)}}return e.forEach(t=>{this.storage.removeItem(t)}),this.options.enableLogging&&e.length,e.length}catch(e){return 0}}}const x=new class{constructor(t={}){this.options={enableMemoryCache:!0,enableBrowserCache:!0,memoryFirst:!0,...t},this.options.enableMemoryCache&&(this.memoryCache=new R(t.memory)),this.options.enableBrowserCache&&(this.browserCache=new P(t.browser))}async set(t,e,s={}){const i={};return this.memoryCache&&(i.memory=this.memoryCache.set(t,e,s)),this.browserCache&&!1!==s.persistent&&(i.browser=this.browserCache.set(t,e,s)),i}async get(t){if(this.options.memoryFirst&&this.memoryCache){const e=this.memoryCache.get(t);if(null!==e)return e}if(this.browserCache){const e=this.browserCache.get(t);if(null!==e)return this.memoryCache&&this.memoryCache.set(t,e),e}return!this.options.memoryFirst&&this.memoryCache?this.memoryCache.get(t):null}async delete(t){const e={};return this.memoryCache&&(e.memory=this.memoryCache.delete(t)),this.browserCache&&(e.browser=this.browserCache.delete(t)),e}async invalidateByTag(t){const e={};return this.memoryCache&&(e.memory=this.memoryCache.invalidateByTag(t)),e.browser=0,e}async clear(){const t={};return this.memoryCache&&(t.memory=this.memoryCache.clear()),this.browserCache&&(t.browser=this.browserCache.clear()),t}async cleanup(){const t={};return this.memoryCache&&(t.memory=this.memoryCache.cleanup()),this.browserCache&&(t.browser=this.browserCache.cleanup()),t}getStats(){return{memory:this.memoryCache?this.memoryCache.getStats():null,browser:this.browserCache?"Available":null}}destroy(){this.memoryCache&&this.memoryCache.destroy()}}({memory:{maxSize:100,defaultTTL:3e5,enableLogging:!1},browser:{storage:"localStorage",prefix:"tournament_cache_",defaultTTL:36e5,enableLogging:!1}});async function D(t,e,s={}){const i=s.cache||x,a=await i.get(t);if(null!==a)return a;try{const a=await e();return await i.set(t,a,s),a}catch(n){if(s.staleWhileRevalidate){const e=await i.get(t);if(null!==e)return e}throw n}}const A={tournaments:{},currentSport:"volleyball",loading:!1,error:null,lastUpdated:null,cache:{},pollingInterval:null},{subscribe:O,set:_,update:V}=t(A),z=3e5,$=["volleyball","table_tennis","soccer"];function B(t){V(e=>({...e,loading:t}))}function M(t){V(e=>({...e,error:t,loading:!1}))}function N(){V(t=>({...t,error:null}))}function U(t){if(!t)throw new Error("スポーツ名が指定されていません");if(!$.includes(t))throw new Error(`サポートされていないスポーツです: ${t}`);return!0}async function F(t=null,e=!0){try{if(N(),t){U(t),B(!0);const s=`tournament_${t}`,i=()=>I.getTournament(t),a=e?await D(s,i,{cache:x,ttl:z,tags:["tournament",t],staleWhileRevalidate:!0}):await i();return a.success?(V(e=>({...e,tournaments:{...e.tournaments,[t]:a.data},loading:!1,lastUpdated:Date.now()})),a):(M(a.message||"トーナメントデータの取得に失敗しました"),a)}{B(!0);const t="tournaments_all",s=()=>I.getTournaments(),i=e?await D(t,s,{cache:x,ttl:z,tags:["tournament","all"],staleWhileRevalidate:!0}):await s();return i.success?(V(t=>({...t,tournaments:i.data,loading:!1,lastUpdated:Date.now()})),i):(M(i.message||"トーナメントデータの取得に失敗しました"),i)}}catch(s){return M(s.message||"予期しないエラーが発生しました"),{success:!1,error:"FETCH_TOURNAMENTS_ERROR",message:s.message||"トーナメントデータの取得に失敗しました"}}}async function H(t=null){try{N();const s=e({subscribe:O}),i=t||s.currentSport;await F(i,!1);return{success:!0,message:"データを更新しました"}}catch(s){return M(s.message||"データの更新に失敗しました"),{success:!1,error:"REFRESH_DATA_ERROR",message:s.message||"データの更新に失敗しました"}}}function W(){e({subscribe:O}).pollingInterval||(E.registerCallback("tournament-data",async()=>{e({subscribe:O}).loading||await H()}),E.registerErrorCallback("tournament-data",async t=>{M("データの更新中にエラーが発生しました")}),E.start(),V(t=>({...t,pollingInterval:"active"})))}function j(){E.unregisterCallback("tournament-data"),E.unregisterErrorCallback("tournament-data");0===E.getStats().callbackCount&&E.stop(),V(t=>({...t,pollingInterval:null}))}const J={subscribe:O,fetchTournaments:F,updateMatch:async function(t,s){try{if(N(),!t)throw new Error("試合IDが指定されていません");if(!s||"object"!=typeof s)throw new Error("試合結果データが正しくありません");B(!0);const i=await S.updateMatch(t,s);if(i.success){const t=e({subscribe:O}).currentSport;return await x.invalidateByTag(["tournament",t]),await F(t,!1),{success:!0,data:i.data,message:"試合結果を更新しました"}}return M(i.message||"試合結果の更新に失敗しました"),i}catch(i){return M(i.message||"予期しないエラーが発生しました"),{success:!1,error:"UPDATE_MATCH_ERROR",message:i.message||"試合結果の更新に失敗しました"}}},switchSport:function(t){try{return U(t),V(e=>({...e,currentSport:t,error:null})),F(t),{success:!0,message:`スポーツを${t}に切り替えました`}}catch(e){return M(e.message||"スポーツの切り替えに失敗しました"),{success:!1,error:"SWITCH_SPORT_ERROR",message:e.message||"スポーツの切り替えに失敗しました"}}},refreshData:H,initialize:async function(){try{return await F(),W(),"undefined"!=typeof document&&document.addEventListener("visibilitychange",()=>{document.hidden||H()}),{success:!0,message:"トーナメントストアを初期化しました"}}catch(t){return M(t.message||"初期化に失敗しました"),{success:!1,error:"INITIALIZE_ERROR",message:t.message||"初期化に失敗しました"}}},cleanup:function(){return j(),_(A),{success:!0,message:"トーナメントストアをクリーンアップしました"}},startPolling:W,stopPolling:j,clearCache:async function(t=null){try{return t?await x.invalidateByTag(["tournament",t]):await x.invalidateByTag(["tournament"]),{success:!0,message:t?`${t}のキャッシュをクリアしました`:"トーナメントキャッシュをクリアしました"}}catch(e){return{success:!1,error:"CLEAR_CACHE_ERROR",message:"キャッシュのクリアに失敗しました"}}},getCacheStats:function(){return x.getStats()},getCurrentTournament:function(){const t=e({subscribe:O});return t.tournaments[t.currentSport]||null},getTournamentBySport:function(t){return U(t),e({subscribe:O}).tournaments[t]||null},getSupportedSports:function(){return[...$]},setLoading:B,setError:M,clearError:N};function K(e,T){s(T,!1);const[I,S]=y(),E=()=>C(_,"$visibleItems",I);let k=i(T,"items",24,()=>[]),R=i(T,"staggerDelay",8,100),P=i(T,"animationType",8,"fadeInUp"),x=i(T,"className",8,""),D=i(T,"itemClassName",8,""),A=i(T,"tag",8,"div"),O=i(T,"itemTag",8,"div");const _=t([]);let V=d(!1);function z(){_.set([]),k().forEach((t,e)=>{setTimeout(()=>{_.update(e=>[...e,t])},e*R())})}a(()=>{b(V,!0),z()}),n(()=>(o(V),r(k())),()=>{o(V)&&k().length>0&&z()}),l(),c();var $=h(),B=u($);g(B,A,!1,(t,e)=>{f(t,()=>({class:`staggered-list ${x()??""}`}),void 0,void 0,"svelte-12xptd");var s=h(),i=u(s);w(i,3,E,(t,e)=>t.id||e,(t,e,s)=>{var i=h(),a=u(i);g(a,O,!1,(t,i)=>{f(t,t=>({class:`stagger-item ${D()??""} ${t??""}`,style:`animation-delay: ${o(s)*(R()/1e3)}s`}),[()=>(r(o(s)),v(()=>function(t){return`animate-${P()} stagger-item-${t}`}(o(s))))],void 0,"svelte-12xptd");var a=h(),n=u(a);L(n,T,"default",{get item(){return o(e)},get index(){return o(s)}}),m(i,a)}),m(t,i)}),m(e,s)}),m(e,$),p(),S()}export{K as S,J as t};
