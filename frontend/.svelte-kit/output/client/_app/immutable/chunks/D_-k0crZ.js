import"./Cm9PB-7n.js";import{i as e}from"./B-6MdqlE.js";import{z as s,ak as t,O as a,al as r,K as n,v as o,am as i,A as c,I as l,G as m,H as d,w as v,u,C as h,J as p,N as g,D as f,F as S,P as b,Q as x,R as T,B as E,T as I}from"./VVabkdHj.js";import{p as w,i as N}from"./BSkGyvYi.js";import{r as _,b as L,s as O,u as D}from"./JJD-QFX9.js";import{d as M,a as y}from"./KE2xTBgs.js";import{c as A,e as U,s as j}from"./DoIqPyr3.js";import{m as R}from"./D8uSMR3S.js";var C=c('<div class="round-info svelte-n4hemx"><span class="round-label svelte-n4hemx">ラウンド:</span> <span class="round-value svelte-n4hemx"> </span></div>'),k=c('<span class="error-message svelte-n4hemx"> </span>'),B=c('<span class="error-message svelte-n4hemx"> </span>'),F=c('<div class="winner-preview svelte-n4hemx"><span class="winner-label svelte-n4hemx">勝者:</span> <span class="winner-value svelte-n4hemx"> </span></div>'),H=c('<span class="loading-spinner svelte-n4hemx"></span> 保存中...',1),P=c('<span class="loading-spinner svelte-n4hemx"></span> 検証中...',1),G=c('<form class="admin-match-form svelte-n4hemx"><h3 class="svelte-n4hemx">試合結果入力</h3> <div class="match-info svelte-n4hemx"><span class="team svelte-n4hemx"> </span> <span class="vs svelte-n4hemx">vs</span> <span class="team svelte-n4hemx"> </span></div> <!> <div class="score-inputs svelte-n4hemx"><div class="score-group svelte-n4hemx"><label for="score1" class="svelte-n4hemx"> </label> <input type="number" id="score1" min="0" max="999" required data-testid="score1" autocomplete="off"/> <!></div> <div class="score-group svelte-n4hemx"><label for="score2" class="svelte-n4hemx"> </label> <input type="number" id="score2" min="0" max="999" required data-testid="score2" autocomplete="off"/> <!></div></div> <!> <input type="hidden" name="csrf_token" class="svelte-n4hemx"/> <div class="form-actions svelte-n4hemx"><button type="button" class="cancel-button svelte-n4hemx">キャンセル</button> <button type="submit" class="submit-button svelte-n4hemx" data-testid="submit-result"><!></button></div></form>');function z(c,z){s(z,!1);const V=a(),q=a();let K=w(z,"match",24,()=>({})),$=w(z,"onSubmit",8,()=>{}),J=w(z,"disabled",8,!1);const Q=t();let X=a(K().score1||""),Y=a(K().score2||""),W=a(!1),Z=a({}),ee=a({score1:!1,score2:!1}),se=a(""),te=a(!1);const ae=M(()=>{if(o(ee).score1||o(ee).score2){n(te,!0);const e=U(o(X).toString(),10),s=U(o(Y).toString(),10);e!==o(X).toString()&&(n(X,e),j.logEvent("INPUT_LENGTH_LIMITED",{field:"score1",originalLength:o(X).toString().length,limitedLength:e.length})),s!==o(Y).toString()&&(n(Y,s),j.logEvent("INPUT_LENGTH_LIMITED",{field:"score2",originalLength:o(Y).toString().length,limitedLength:s.length}));const t=y(o(X),o(Y),K().team1,K().team2);if(n(Z,t.errors),!t.isValid&&(t.errors.score1||t.errors.score2)){Object.values(t.errors).some(e=>e.includes("不正")||e.includes("スクリプト")||e.includes("文字"))&&j.logEvent("FORM_SECURITY_VIOLATION",{component:"AdminMatchForm",matchId:K().id,errors:t.errors,values:{score1:o(X),score2:o(Y)}})}n(te,!1)}},300);function re(e){b(ee,o(ee)[e]=!0)}function ne(e,s){const t=U(s.toString(),10);t!==s.toString()&&j.logEvent("INPUT_LENGTH_EXCEEDED",{component:"AdminMatchForm",field:e,originalLength:s.toString().length,limitedLength:t.length}),"score1"===e?n(X,t):"score2"===e&&n(Y,t),re(e)}r(()=>A,()=>{"undefined"!=typeof window&&n(se,A.getToken())}),r(()=>o(ee),()=>{(o(ee).score1||o(ee).score2)&&ae()}),r(()=>(o(Z),o(X),o(Y)),()=>{n(V,0===Object.keys(o(Z)).length&&""!==o(X)&&""!==o(Y))}),r(()=>(o(X),o(Y)),()=>{n(q,function(e,s){const t=Number(e),a=Number(s);return isNaN(t)||isNaN(a)||""===e||""===s?"":t>a?K().team1||"Team A":a>t?K().team2||"Team B":"引き分け"}(o(X),o(Y)))}),i(),e();var oe=G(),ie=l(m(oe),2),ce=m(ie),le=m(ce,!0);d(ce);var me=l(ce,4),de=m(me,!0);d(me),d(ie);var ve=l(ie,2),ue=e=>{var s=C(),t=l(m(s),2),a=m(t,!0);d(t),d(s),h(()=>p(a,(v(K()),u(()=>K().round)))),f(e,s)};N(ve,e=>{v(K()),u(()=>K().round)&&e(ue)});var he=l(ve,2),pe=m(he),ge=m(pe),fe=m(ge);d(ge);var Se=l(ge,2);let be;_(Se);var xe=l(Se,2),Te=e=>{var s=k(),t=m(s,!0);d(s),h(()=>p(t,(o(Z),u(()=>o(Z).score1)))),f(e,s)};N(xe,e=>{o(Z),u(()=>o(Z).score1)&&e(Te)}),d(pe);var Ee=l(pe,2),Ie=m(Ee),we=m(Ie);d(Ie);var Ne=l(Ie,2);let _e;_(Ne);var Le=l(Ne,2),Oe=e=>{var s=B(),t=m(s,!0);d(s),h(()=>p(t,(o(Z),u(()=>o(Z).score2)))),f(e,s)};N(Le,e=>{o(Z),u(()=>o(Z).score2)&&e(Oe)}),d(Ee),d(he);var De=l(he,2),Me=e=>{var s=F(),t=l(m(s),2),a=m(t,!0);d(t),d(s),h(()=>p(a,o(q))),f(e,s)};N(De,e=>{o(q)&&o(V)&&e(Me)});var ye=l(De,2);_(ye);var Ae,Ue=l(ye,2),je=m(Ue),Re=l(je,2),Ce=m(Re),ke=e=>{var s=H();x(),f(e,s)},Be=e=>{var s=T(),t=E(s),a=e=>{var s=P();x(),f(e,s)},r=e=>{var s=I("結果を保存");f(e,s)};N(t,e=>{o(te)?e(a):e(r,!1)},!0),f(e,s)};N(Ce,e=>{o(W)?e(ke):e(Be,!1)}),d(Re),d(Ue),d(oe),h((e,s)=>{p(le,(v(K()),u(()=>K().team1||"Team A"))),p(de,(v(K()),u(()=>K().team2||"Team B"))),p(fe,`${v(K()),u(()=>K().team1||"Team A")??""} スコア`),L(Se,o(X)),Se.disabled=J()||o(W)||o(te),be=O(Se,1,"svelte-n4hemx",null,be,e),p(we,`${v(K()),u(()=>K().team2||"Team B")??""} スコア`),L(Ne,o(Y)),Ne.disabled=J()||o(W)||o(te),_e=O(Ne,1,"svelte-n4hemx",null,_e,s),L(ye,o(se)),je.disabled=o(W)||o(te),Re.disabled=!o(V)||J()||o(W)||o(te)},[()=>({error:o(Z).score1}),()=>({error:o(Z).score2})]),g("input",Se,e=>ne("score1",e.target.value)),g("blur",Se,()=>re("score1")),g("input",Ne,e=>ne("score2",e.target.value)),g("blur",Ne,()=>re("score2")),g("click",je,function(){n(X,K().score1||""),n(Y,K().score2||""),n(Z,{}),n(ee,{score1:!1,score2:!1}),Q("cancel")}),g("submit",oe,(Ae=async function(){n(ee,{score1:!0,score2:!0});const e=y(o(X),o(Y),K().team1,K().team2);if(!e.isValid)return n(Z,e.errors),D.showNotification("入力内容を確認してください","error"),void j.logEvent("FORM_SUBMISSION_BLOCKED",{component:"AdminMatchForm",matchId:K().id,errors:e.errors,timestamp:(new Date).toISOString()});n(W,!0),D.setLoading(!0);try{const s={score1:e.sanitizedData.score1,score2:e.sanitizedData.score2,winner:o(q),csrfToken:o(se)};if(j.logEvent("MATCH_RESULT_SUBMISSION",{matchId:K().id,team1:K().team1,team2:K().team2,score1:s.score1,score2:s.score2,winner:s.winner,timestamp:(new Date).toISOString()}),K().id){const e=await R.updateMatch(K().id,s);if(!e.success)throw new Error(e.message||"試合結果の更新に失敗しました");D.showNotification("試合結果を更新しました","success"),j.logEvent("MATCH_RESULT_UPDATE_SUCCESS",{matchId:K().id,timestamp:(new Date).toISOString()}),Q("success",{match:K().id,result:s}),"function"==typeof $()&&$()(s)}else"function"==typeof $()&&await $()(s),D.showNotification("試合結果を保存しました","success"),Q("success",{result:s})}catch(s){j.logEvent("MATCH_RESULT_SUBMISSION_ERROR",{matchId:K().id,error:s.message,timestamp:(new Date).toISOString()});let e="試合結果の保存に失敗しました";s.message&&s.message.includes("CSRF")?(e="セキュリティトークンが無効です。ページを再読み込みしてください。",n(se,A.refreshToken())):s.message&&(e=s.message),D.showNotification(e,"error"),Q("error",{error:s.message})}finally{n(W,!1),D.setLoading(!1)}},function(...e){return e[0].preventDefault(),Ae?.apply(this,e)})),f(c,oe),S()}export{z as default};
