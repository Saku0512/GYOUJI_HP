import{R as t}from"./D2AUiy-P.js";import{w as e,T as n}from"./BRFgxvOq.js";import{a as r}from"./DiqqC9HZ.js";const a="tournament_auth_token",o="tournament_user_data";function i(t,e){try{const n=JSON.stringify(e);return localStorage.setItem(t,n),!0}catch(n){return!1}}function s(t,e=null){try{const n=localStorage.getItem(t);return null===n?e:JSON.parse(n)}catch(n){return e}}function c(t){try{return localStorage.removeItem(t),!0}catch(e){return!1}}function u(t){return i(a,t)}function d(){return s(a)}function h(t){return i(o,t)}function l(){return s(o)}function f(){c(a),c(o)}const w={isAuthenticated:!1,token:null,user:null,loading:!1};const g=function(){const{subscribe:t,set:a,update:o}=e(w);return{subscribe:t,setLoading:t=>{o(e=>({...e,loading:t}))},setAuthState:t=>{o(e=>({...e,isAuthenticated:!!t.token,token:t.token,user:t.user,loading:!1}))},clearAuth:()=>{a({...w})},login:async t=>{o(t=>({...t,loading:!0}));try{const e=await r.login(t.username,t.password);if(e.success){e.data.token,e.data.user;return u(e.data.token),h(e.data.user),o(t=>({...t,isAuthenticated:!0,token:e.data.token,user:e.data.user,loading:!1})),e}return o(t=>({...t,loading:!1})),e}catch(e){return o(t=>({...t,loading:!1})),{success:!1,error:"LOGIN_STORE_ERROR",message:"ログイン処理でエラーが発生しました",details:e.message}}},logout:async()=>{o(t=>({...t,loading:!0}));try{const t=await r.logout();return f(),a({...w}),t}catch(t){return f(),a({...w}),{success:!0,message:"ログアウトしました",warning:"サーバーとの通信でエラーが発生しましたが、ローカルの認証情報はクリアされました"}}},checkAuthStatus:async()=>{o(t=>({...t,loading:!0}));try{const t=d(),e=l();if(!t)return o(t=>({...t,loading:!1})),{success:!1,error:"NO_TOKEN",message:"トークンが見つかりません"};const n=await r.validateToken();return n.success?(o(r=>({...r,isAuthenticated:!0,token:t,user:n.data?.user||e,loading:!1})),n):(f(),a({...w}),n)}catch(t){return f(),a({...w}),{success:!1,error:"AUTH_CHECK_ERROR",message:"認証状態の確認でエラーが発生しました",details:t.message}}},refreshToken:async()=>{if(n({subscribe:t}).loading)return{success:!1,error:"ALREADY_LOADING",message:"既に処理中です"};o(t=>({...t,loading:!0}));try{const t=await r.refreshToken();if(t.success){t.data.token,t.data.user;return u(t.data.token),h(t.data.user),o(e=>({...e,isAuthenticated:!0,token:t.data.token,user:t.data.user,loading:!1})),t}return f(),a({...w}),t}catch(e){return f(),a({...w}),{success:!1,error:"REFRESH_STORE_ERROR",message:"トークンの更新でエラーが発生しました",details:e.message}}},initialize:async function(){const t=d(),e=l();t&&e&&await this.checkAuthStatus()}}}();function m(e,n){throw new t(e,n.toString())}function p(t){if(!t)return!0;try{const e=JSON.parse(atob(t.split(".")[1])),n=Math.floor(Date.now()/1e3),r=300;return e.exp<n+r}catch(e){return!0}}async function y(t,e={}){const r=await async function(t,e={}){const{redirectTo:n="/login",allowExpired:r=!1,checkServer:a=!0}=e;if("undefined"==typeof window)return{authenticated:!1};const o=d();if(!o)throw m(302,`${n}?redirect=${encodeURIComponent(t.pathname+t.search)}`);if(!r&&p(o))try{if(!(await g.refreshToken()).success)throw m(302,`${n}?expired=true&redirect=${encodeURIComponent(t.pathname+t.search)}`)}catch(i){throw m(302,`${n}?expired=true&redirect=${encodeURIComponent(t.pathname+t.search)}`)}if(a)try{if(!(await g.checkAuthStatus()).success)throw m(302,`${n}?invalid=true&redirect=${encodeURIComponent(t.pathname+t.search)}`)}catch(i){throw m(302,`${n}?error=true&redirect=${encodeURIComponent(t.pathname+t.search)}`)}return{authenticated:!0}}(t,e);if(!r.authenticated)return r;const a=n(g).user;if(!a||"admin"!==a.role)throw m(302,"/login?unauthorized=true");return{authenticated:!0,isAdmin:!0}}function k(t,e={}){const{redirectTo:n="/admin",checkExpired:r=!0}=e;if("undefined"==typeof window)return{shouldRedirect:!1};const a=d();if(a&&(!r||!p(a))){throw m(302,t.searchParams.get("redirect")||n)}return{shouldRedirect:!1}}function R(){if("undefined"==typeof window)return;let t,e;return e=async()=>{if(!document.hidden){if(d())try{!(await g.checkAuthStatus()).success&&window.location.pathname.startsWith("/admin")&&(window.location.href="/login?session_expired=true")}catch(t){}}},document.addEventListener("visibilitychange",e),t=setInterval(async()=>{const t=d();if(t&&p(t))try{(await g.refreshToken()).success||(await g.logout(),window.location.pathname.startsWith("/admin")&&(window.location.href="/login?expired=true"))}catch(e){await g.logout(),window.location.pathname.startsWith("/admin")&&(window.location.href="/login?error=true")}},6e4),()=>{t&&clearInterval(t),e&&document.removeEventListener("visibilitychange",e)}}async function A(t="/login"){try{await g.logout(),"undefined"!=typeof window&&(window.location.href=t)}catch(e){"undefined"!=typeof window&&(window.location.href=t+"?logout_error=true")}}"undefined"!=typeof window&&(g.initialize(),window.addEventListener("auth:logout",()=>{g.clearAuth()}),document.addEventListener("visibilitychange",()=>{if(!document.hidden){d()&&g.checkAuthStatus()}}));export{g as a,y as b,A as p,k as r,R as s};
