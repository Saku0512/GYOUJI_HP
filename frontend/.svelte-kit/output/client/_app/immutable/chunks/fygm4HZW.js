import"./Cm9PB-7n.js";import"./BB0NFQV6.js";import{p as e,x as s,y as t,m as a,z as r,q as n,g as o,A as i,i as c,f as l,l as m,k as d,r as v,a as u,B as h,C as p,D as g,t as f,j as S,E as b,s as x,b as E,F as I,c as T,d as w,G as N,n as _,H as L,I as O,v as M}from"./BRFgxvOq.js";import{d as y,v as D}from"./BDipnjnj.js";import{c as A,e as U,s as C}from"./DoIqPyr3.js";import{u as R,m as j}from"./DiqqC9HZ.js";var B=l('<div class="round-info svelte-n4hemx"><span class="round-label svelte-n4hemx">ラウンド:</span> <span class="round-value svelte-n4hemx"> </span></div>'),k=l('<span class="error-message svelte-n4hemx"> </span>'),F=l('<span class="error-message svelte-n4hemx"> </span>'),H=l('<div class="winner-preview svelte-n4hemx"><span class="winner-label svelte-n4hemx">勝者:</span> <span class="winner-value svelte-n4hemx"> </span></div>'),G=l('<span class="loading-spinner svelte-n4hemx"></span> 保存中...',1),P=l('<span class="loading-spinner svelte-n4hemx"></span> 検証中...',1),q=l('<form class="admin-match-form svelte-n4hemx"><h3 class="svelte-n4hemx">試合結果入力</h3> <div class="match-info svelte-n4hemx"><span class="team svelte-n4hemx"> </span> <span class="vs svelte-n4hemx">vs</span> <span class="team svelte-n4hemx"> </span></div> <!> <div class="score-inputs svelte-n4hemx"><div class="score-group svelte-n4hemx"><label for="score1" class="svelte-n4hemx"> </label> <input type="number" id="score1" min="0" max="999" required data-testid="score1" autocomplete="off"/> <!></div> <div class="score-group svelte-n4hemx"><label for="score2" class="svelte-n4hemx"> </label> <input type="number" id="score2" min="0" max="999" required data-testid="score2" autocomplete="off"/> <!></div></div> <!> <input type="hidden" name="csrf_token" class="svelte-n4hemx"/> <div class="form-actions svelte-n4hemx"><button type="button" class="cancel-button svelte-n4hemx">キャンセル</button> <button type="submit" class="submit-button svelte-n4hemx" data-testid="submit-result"><!></button></div></form>');function z(l,z){e(z,!1);const V=a(),$=a();let K=s(z,"match",24,()=>({})),X=s(z,"onSubmit",8,()=>{}),Y=s(z,"disabled",8,!1);const J=t();let Q=a(K().score1||""),W=a(K().score2||""),Z=a(!1),ee=a({}),se=a({score1:!1,score2:!1}),te=a(""),ae=a(!1);const re=y(()=>{if(o(se).score1||o(se).score2){n(ae,!0);const e=U(o(Q).toString(),10),s=U(o(W).toString(),10);e!==o(Q).toString()&&(n(Q,e),C.logEvent("INPUT_LENGTH_LIMITED",{field:"score1",originalLength:o(Q).toString().length,limitedLength:e.length})),s!==o(W).toString()&&(n(W,s),C.logEvent("INPUT_LENGTH_LIMITED",{field:"score2",originalLength:o(W).toString().length,limitedLength:s.length}));const t=D(o(Q),o(W),K().team1,K().team2);if(n(ee,t.errors),!t.isValid&&(t.errors.score1||t.errors.score2)){Object.values(t.errors).some(e=>e.includes("不正")||e.includes("スクリプト")||e.includes("文字"))&&C.logEvent("FORM_SECURITY_VIOLATION",{component:"AdminMatchForm",matchId:K().id,errors:t.errors,values:{score1:o(Q),score2:o(W)}})}n(ae,!1)}},300);function ne(e){N(se,o(se)[e]=!0)}function oe(e,s){const t=U(s.toString(),10);t!==s.toString()&&C.logEvent("INPUT_LENGTH_EXCEEDED",{component:"AdminMatchForm",field:e,originalLength:s.toString().length,limitedLength:t.length}),"score1"===e?n(Q,t):"score2"===e&&n(W,t),ne(e)}r(()=>A,()=>{"undefined"!=typeof window&&n(te,A.getToken())}),r(()=>o(se),()=>{(o(se).score1||o(se).score2)&&re()}),r(()=>(o(ee),o(Q),o(W)),()=>{n(V,0===Object.keys(o(ee)).length&&""!==o(Q)&&""!==o(W))}),r(()=>(o(Q),o(W)),()=>{n($,function(e,s){const t=Number(e),a=Number(s);return isNaN(t)||isNaN(a)||""===e||""===s?"":t>a?K().team1||"Team A":a>t?K().team2||"Team B":"引き分け"}(o(Q),o(W)))}),i(),c();var ie=q(),ce=m(d(ie),2),le=d(ce),me=d(le,!0);v(le);var de=m(le,4),ve=d(de,!0);v(de),v(ce);var ue=m(ce,2),he=e=>{var s=B(),t=m(d(s),2),a=d(t,!0);v(t),v(s),f(()=>S(a,(h(K()),p(()=>K().round)))),T(e,s)};u(ue,e=>{h(K()),p(()=>K().round)&&e(he)});var pe=m(ue,2),ge=d(pe),fe=d(ge),Se=d(fe);v(fe);var be=m(fe,2);let xe;g(be);var Ee=m(be,2),Ie=e=>{var s=k(),t=d(s,!0);v(s),f(()=>S(t,(o(ee),p(()=>o(ee).score1)))),T(e,s)};u(Ee,e=>{o(ee),p(()=>o(ee).score1)&&e(Ie)}),v(ge);var Te=m(ge,2),we=d(Te),Ne=d(we);v(we);var _e=m(we,2);let Le;g(_e);var Oe=m(_e,2),Me=e=>{var s=F(),t=d(s,!0);v(s),f(()=>S(t,(o(ee),p(()=>o(ee).score2)))),T(e,s)};u(Oe,e=>{o(ee),p(()=>o(ee).score2)&&e(Me)}),v(Te),v(pe);var ye=m(pe,2),De=e=>{var s=H(),t=m(d(s),2),a=d(t,!0);v(t),v(s),f(()=>S(a,o($))),T(e,s)};u(ye,e=>{o($)&&o(V)&&e(De)});var Ae=m(ye,2);g(Ae);var Ue=m(Ae,2),Ce=d(Ue),Re=m(Ce,2),je=d(Re),Be=e=>{var s=G();_(),T(e,s)},ke=e=>{var s=L(),t=O(s),a=e=>{var s=P();_(),T(e,s)},r=e=>{var s=M("結果を保存");T(e,s)};u(t,e=>{o(ae)?e(a):e(r,!1)},!0),T(e,s)};u(je,e=>{o(Z)?e(Be):e(ke,!1)}),v(Re),v(Ue),v(ie),f((e,s)=>{S(me,(h(K()),p(()=>K().team1||"Team A"))),S(ve,(h(K()),p(()=>K().team2||"Team B"))),S(Se,`${h(K()),p(()=>K().team1||"Team A")??""} スコア`),b(be,o(Q)),be.disabled=Y()||o(Z)||o(ae),xe=x(be,1,"svelte-n4hemx",null,xe,e),S(Ne,`${h(K()),p(()=>K().team2||"Team B")??""} スコア`),b(_e,o(W)),_e.disabled=Y()||o(Z)||o(ae),Le=x(_e,1,"svelte-n4hemx",null,Le,s),b(Ae,o(te)),Ce.disabled=o(Z)||o(ae),Re.disabled=!o(V)||Y()||o(Z)||o(ae)},[()=>({error:o(ee).score1}),()=>({error:o(ee).score2})]),E("input",be,e=>oe("score1",e.target.value)),E("blur",be,()=>ne("score1")),E("input",_e,e=>oe("score2",e.target.value)),E("blur",_e,()=>ne("score2")),E("click",Ce,function(){n(Q,K().score1||""),n(W,K().score2||""),n(ee,{}),n(se,{score1:!1,score2:!1}),J("cancel")}),E("submit",ie,I(async function(){n(se,{score1:!0,score2:!0});const e=D(o(Q),o(W),K().team1,K().team2);if(!e.isValid)return n(ee,e.errors),R.showNotification("入力内容を確認してください","error"),void C.logEvent("FORM_SUBMISSION_BLOCKED",{component:"AdminMatchForm",matchId:K().id,errors:e.errors,timestamp:(new Date).toISOString()});n(Z,!0),R.setLoading(!0);try{const s={score1:e.sanitizedData.score1,score2:e.sanitizedData.score2,winner:o($),csrfToken:o(te)};if(C.logEvent("MATCH_RESULT_SUBMISSION",{matchId:K().id,team1:K().team1,team2:K().team2,score1:s.score1,score2:s.score2,winner:s.winner,timestamp:(new Date).toISOString()}),K().id){const e=await j.updateMatch(K().id,s);if(!e.success)throw new Error(e.message||"試合結果の更新に失敗しました");R.showNotification("試合結果を更新しました","success"),C.logEvent("MATCH_RESULT_UPDATE_SUCCESS",{matchId:K().id,timestamp:(new Date).toISOString()}),J("success",{match:K().id,result:s}),"function"==typeof X()&&X()(s)}else"function"==typeof X()&&await X()(s),R.showNotification("試合結果を保存しました","success"),J("success",{result:s})}catch(s){C.logEvent("MATCH_RESULT_SUBMISSION_ERROR",{matchId:K().id,error:s.message,timestamp:(new Date).toISOString()});let e="試合結果の保存に失敗しました";s.message&&s.message.includes("CSRF")?(e="セキュリティトークンが無効です。ページを再読み込みしてください。",n(te,A.refreshToken())):s.message&&(e=s.message),R.showNotification(e,"error"),J("error",{error:s.message})}finally{n(Z,!1),R.setLoading(!1)}})),T(l,ie),w()}export{z as default};
