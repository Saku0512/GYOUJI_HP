import{r as e,a as s}from"../chunks/Dp5EjsQM.js";import"../chunks/Cm9PB-7n.js";import"../chunks/BB0NFQV6.js";import{p as r,x as a,q as t,o as n,i as o,f as i,h as l,a as m,t as d,J as u,g as v,b as p,c,d as g,$ as b,l as w,k as f,s as _,K as E,j as h,E as I,C as T,m as y,D as S,r as k,G as O,B as A,n as D,H as L,I as N,v as P}from"../chunks/BRFgxvOq.js";import{g as R}from"../chunks/BOLYuTPu.js";import{d as x,a as j}from"../chunks/BDipnjnj.js";import{c as C,s as G,d as M}from"../chunks/DoIqPyr3.js";const z=Object.freeze(Object.defineProperty({__proto__:null,load:async function({url:s}){return e(s,{redirectTo:"/admin",checkExpired:!0}),{errorType:s.searchParams.get("expired")?"expired":s.searchParams.get("invalid")?"invalid":s.searchParams.get("unauthorized")?"unauthorized":s.searchParams.get("network_error")?"network_error":s.searchParams.get("logout_error")?"logout_error":s.searchParams.get("session_expired")?"session_expired":s.searchParams.get("error")?"error":null,redirectTarget:s.searchParams.get("redirect")}}},Symbol.toStringTag,{value:"Module"}));var q=i('<div class="alert alert-error svelte-m98b94" role="alert"> </div>'),F=i('<div class="alert alert-success svelte-m98b94" role="alert"> </div>'),U=i('<div class="alert alert-warning svelte-m98b94" role="alert"> </div>'),K=i('<span class="error-message svelte-m98b94"> </span>'),V=i('<span class="error-message svelte-m98b94"> </span>'),$=i('<span class="loading-spinner svelte-m98b94"></span> ログイン中...',1),H=i('<div class="loading-overlay svelte-m98b94"><div class="loading-content svelte-m98b94"><span class="loading-spinner large svelte-m98b94"></span> <p class="svelte-m98b94">認証中...</p></div></div>'),B=i('<div class="login-container svelte-m98b94"><div class="login-card svelte-m98b94"><h1 class="svelte-m98b94">管理者ログイン</h1> <p class="login-description svelte-m98b94">トーナメント管理システムの管理者ダッシュボードにアクセスするには、認証情報を入力してください。</p> <!> <!> <!> <form novalidate="" class="svelte-m98b94"><div class="form-group svelte-m98b94"><label for="username">ユーザー名</label> <input type="text" id="username" name="username" autocomplete="username" data-testid="username" required/> <!></div> <div class="form-group svelte-m98b94"><label for="password">パスワード</label> <div class="password-input-container svelte-m98b94"><input id="password" name="password" autocomplete="current-password" data-testid="password" required/> <button type="button" class="password-toggle svelte-m98b94"> </button></div> <!></div> <input type="hidden" name="csrf_token" class="svelte-m98b94"/> <button type="submit" class="login-button svelte-m98b94" data-testid="login-button"><!></button></form> <!></div></div>');function J(e,i){r(i,!1);let z=a(i,"data",8),J=y({username:"",password:""}),X=y({}),Q=y(!1),W=y(!1),Y=0,Z=y(!1),ee=y(""),se=y(""),re=y(""),ae=y({});s.subscribe(e=>{t(ae,e)}),n(()=>{var e;if(t(ee,C.getToken()),z().errorType&&(e=z().errorType,t(se,{expired:"セッションの有効期限が切れました。再度ログインしてください。",invalid:"トークンが無効です。再度ログインしてください。",unauthorized:"アクセス権限がありません。",network_error:"ネットワークエラーが発生しました。",logout_error:"ログアウト処理でエラーが発生しましたが、認証情報はクリアされました。",session_expired:"セッションが期限切れになりました。",error:"エラーが発生しました。再度お試しください。"}[e]||"エラーが発生しました。"),G.logEvent("LOGIN_PAGE_ERROR",{errorType:e,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})),v(ae).isAuthenticated){const e=z().redirectTarget||"/admin";R(e)}});const te=x(e=>{const s=j(v(J).username,v(J).password);s.errors[e]?O(X,v(X)[e]=s.errors[e]):delete v(X)[e],t(X,{...v(X)})},300);function ne(e){te(e)}async function oe(e){if(e.preventDefault(),v(Q))return;const r=`login_${v(J).username||"anonymous"}`;if(!M.isAllowed(r))return t(Z,!0),t(se,"ログイン試行回数が上限に達しました。しばらく待ってから再試行してください。"),void G.logEvent("RATE_LIMIT_EXCEEDED",{username:v(J).username,attempts:Y,clientId:r});const a=j(v(J).username,v(J).password);if(!a.isValid)return t(X,a.errors),t(se,"入力内容を確認してください"),void G.logEvent("LOGIN_VALIDATION_FAILED",{username:v(J).username,errors:a.errors});t(X,{}),t(se,""),t(Q,!0),Y++;try{const e={username:a.sanitizedData.username,password:a.sanitizedData.password,csrfToken:v(ee)};G.logEvent("LOGIN_ATTEMPT",{username:e.username,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent});const r=await s.login(e);if(r.success){t(re,"ログインに成功しました"),Y=0,G.logEvent("LOGIN_SUCCESS",{username:e.username,timestamp:(new Date).toISOString()});const s=z().redirectTarget||"/admin";setTimeout(()=>{R(s)},1e3)}else{let s="ログインに失敗しました";"INVALID_CREDENTIALS"===r.error?s="ユーザー名またはパスワードが正しくありません":"ACCOUNT_LOCKED"===r.error?s="アカウントがロックされています":"CSRF_TOKEN_MISMATCH"===r.error?(s="セキュリティトークンが無効です。ページを再読み込みしてください。",t(ee,C.refreshToken())):r.message&&(s=r.message),t(se,s),G.logEvent("LOGIN_FAILED",{username:e.username,error:r.error,attempts:Y,timestamp:(new Date).toISOString()}),O(J,v(J).password=""),Y>=3&&G.logEvent("MULTIPLE_LOGIN_FAILURES",{username:e.username,attempts:Y,timestamp:(new Date).toISOString()})}}catch(n){t(se,"ログイン処理でエラーが発生しました"),G.logEvent("LOGIN_ERROR",{username:v(J).username,error:n.message,attempts:Y,timestamp:(new Date).toISOString()}),O(J,v(J).password="")}finally{t(Q,!1)}}function ie(e){"Enter"!==e.key||v(Q)||oe(e)}o();var le=B();l(e=>{b.title="管理者ログイン - Tournament Management System"});var me=f(le),de=w(f(me),4),ue=e=>{var s=q(),r=f(s,!0);k(s),d(()=>h(r,v(se))),c(e,s)};m(de,e=>{v(se)&&e(ue)});var ve=w(de,2),pe=e=>{var s=F(),r=f(s,!0);k(s),d(()=>h(r,v(re))),c(e,s)};m(ve,e=>{v(re)&&e(pe)});var ce=w(ve,2),ge=e=>{var s=U(),r=f(s);k(s),d(e=>h(r,`セキュリティのため、ログイン試行が一時的に制限されています。\n        残り試行回数: ${e??""}`),[()=>(A(M),v(J),T(()=>M.getRemainingRequests(v(J).username||"anonymous")))]),c(e,s)};m(ce,e=>{v(Z)&&e(ge)});var be=w(ce,2),we=f(be),fe=f(we);let _e;var Ee=w(fe,2);let he;S(Ee);var Ie=w(Ee,2),Te=e=>{var s=K(),r=f(s,!0);k(s),d(()=>h(r,(v(X),T(()=>v(X).username)))),c(e,s)};m(Ie,e=>{v(X),T(()=>v(X).username)&&e(Te)}),k(we);var ye=w(we,2),Se=f(ye);let ke;var Oe=w(Se,2),Ae=f(Oe);let De;S(Ae);var Le=w(Ae,2),Ne=f(Le,!0);k(Le),k(Oe);var Pe=w(Oe,2),Re=e=>{var s=V(),r=f(s,!0);k(s),d(()=>h(r,(v(X),T(()=>v(X).password)))),c(e,s)};m(Pe,e=>{v(X),T(()=>v(X).password)&&e(Re)}),k(ye);var xe=w(ye,2);S(xe);var je=w(xe,2),Ce=f(je),Ge=e=>{var s=$();D(),c(e,s)},Me=e=>{var s=L(),r=N(s),a=e=>{var s=P("制限中");c(e,s)},t=e=>{var s=P("ログイン");c(e,s)};m(r,e=>{v(Z)?e(a):e(t,!1)},!0),c(e,s)};m(Ce,e=>{v(Q),v(ae),T(()=>v(Q)||v(ae).loading)?e(Ge):e(Me,!1)}),k(je),k(be);var ze=w(be,2),qe=e=>{var s=H();c(e,s)};m(ze,e=>{v(ae),T(()=>v(ae).loading)&&e(qe)}),k(me),k(le),d((e,s,r,a)=>{_e=_(fe,1,"svelte-m98b94",null,_e,e),Ee.disabled=v(Q),he=_(Ee,1,"svelte-m98b94",null,he,s),ke=_(Se,1,"svelte-m98b94",null,ke,r),E(Ae,"type",v(W)?"text":"password"),Ae.disabled=v(Q),De=_(Ae,1,"svelte-m98b94",null,De,a),Le.disabled=v(Q),E(Le,"aria-label",v(W)?"パスワードを隠す":"パスワードを表示"),h(Ne,v(W)?"🙈":"👁️"),I(xe,v(ee)),je.disabled=(v(Q),v(ae),v(Z),T(()=>v(Q)||v(ae).loading||v(Z)))},[()=>({error:v(X).username}),()=>({error:v(X).username}),()=>({error:v(X).password}),()=>({error:v(X).password})]),u(Ee,()=>v(J).username,e=>O(J,v(J).username=e)),p("blur",Ee,()=>ne("username")),p("input",Ee,()=>ne("username")),p("keydown",Ee,ie),u(Ae,()=>v(J).password,e=>O(J,v(J).password=e)),p("blur",Ae,()=>ne("password")),p("input",Ae,()=>ne("password")),p("keydown",Ae,ie),p("click",Le,function(){t(W,!v(W))}),p("submit",be,oe),c(e,le),g()}export{J as component,z as universal};
