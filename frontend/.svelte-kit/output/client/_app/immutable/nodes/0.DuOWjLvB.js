import"../chunks/DsnmJJEf.js";import"../chunks/CemgtdTq.js";import{w as Ve,g as Ye,c as Qe,s as We,e as I,o as Xe}from"../chunks/CAxiFA8R.js";import{y as je,z as qe,p as Ie,R as B,Q as q,aa as ke,n as Z,g as o,m as f,o as Ke,k as S,s as u,v as c,w as v,t as z,aG as ce,aH as Ee,aI as Ze,aJ as $e,u as R,aK as Re}from"../chunks/DZk1ynsy.js";import{p as le,i as w,s as et,a as me}from"../chunks/uc740CFE.js";import{a as tt,s as y,e as rt,u as U,b as st,c as at,L as ot}from"../chunks/BSPZMg3t.js";import{i as xe}from"../chunks/ButnKw6t.js";import{s as nt,g as it}from"../chunks/BmASRNrV.js";import{b as lt}from"../chunks/DFnI3FC6.js";function ct(i,e,s,t,r){je&&qe();var n=e.$$slots?.[s],d=!1;n===!0&&(n=e.children,d=!0),n===void 0||n(i,d?()=>t:t)}const ut=()=>{const i=nt;return{page:{subscribe:i.page.subscribe},navigating:{subscribe:i.navigating.subscribe},updated:i.updated}},dt={subscribe(i){return ut().page.subscribe(i)}};class vt{constructor(e=tt){this.client=e,this.tokenKey="auth_token",this.refreshTokenKey="refresh_token",this.userKey="auth_user"}getStoredToken(){return typeof window>"u"?null:localStorage.getItem(this.tokenKey)}getStoredRefreshToken(){return typeof window>"u"?null:localStorage.getItem(this.refreshTokenKey)}getStoredUser(){if(typeof window>"u")return null;const e=localStorage.getItem(this.userKey);try{return e?JSON.parse(e):null}catch(s){return console.error("Failed to parse stored user data:",s),null}}storeToken(e,s=null,t=null){typeof window>"u"||(localStorage.setItem(this.tokenKey,e),s&&localStorage.setItem(this.refreshTokenKey,s),t&&localStorage.setItem(this.userKey,JSON.stringify(t)),this.client.setToken(e))}clearStoredAuth(){typeof window>"u"||(localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.refreshTokenKey),localStorage.removeItem(this.userKey),this.client.setToken(null))}isTokenExpired(e){if(!e)return!0;try{const s=JSON.parse(atob(e.split(".")[1])),t=Math.floor(Date.now()/1e3);return s.exp<t}catch(s){return console.error("Failed to parse JWT token:",s),!0}}initializeAuth(){const e=this.getStoredToken();return e&&!this.isTokenExpired(e)?(this.client.setToken(e),!0):(e&&this.clearStoredAuth(),!1)}async login(e,s){try{const t=await this.client.post("/auth/login",{username:e,password:s});if(t.success&&t.data){const{token:r,refresh_token:n,user:d}=t.data;return this.storeToken(r,n,d),{success:!0,data:{token:r,refresh_token:n,user:d},message:"ログインに成功しました"}}return t}catch(t){return console.error("Login error:",t),{success:!1,error:"LOGIN_ERROR",message:"ログインに失敗しました",details:t.message}}}async logout(){try{return this.getStoredToken()&&await this.client.post("/auth/logout"),this.clearStoredAuth(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("auth:logout")),{success:!0,message:"ログアウトしました"}}catch(e){return console.error("Logout error:",e),this.clearStoredAuth(),{success:!0,message:"ログアウトしました",warning:"サーバーとの通信でエラーが発生しましたが、ローカルの認証情報はクリアされました"}}}async refreshToken(){try{const e=this.getStoredRefreshToken();if(!e)return{success:!1,error:"NO_REFRESH_TOKEN",message:"リフレッシュトークンが見つかりません"};const s=await this.client.post("/auth/refresh",{refresh_token:e});if(s.success&&s.data){const{token:t,refresh_token:r,user:n}=s.data;return this.storeToken(t,r||e,n),{success:!0,data:{token:t,refresh_token:r||e,user:n},message:"トークンを更新しました"}}return this.clearStoredAuth(),s}catch(e){return console.error("Token refresh error:",e),this.clearStoredAuth(),{success:!1,error:"REFRESH_ERROR",message:"トークンの更新に失敗しました",details:e.message}}}async validateToken(){try{const e=this.getStoredToken();if(!e)return{success:!1,error:"NO_TOKEN",message:"トークンが見つかりません"};if(this.isTokenExpired(e)){const t=await this.refreshToken();return t.success?{success:!0,data:t.data,message:"トークンを更新して検証しました"}:{success:!1,error:"TOKEN_EXPIRED",message:"トークンの期限が切れています"}}const s=await this.client.get("/auth/validate");return s.success?{success:!0,data:s.data,message:"トークンは有効です"}:(this.clearStoredAuth(),s)}catch(e){return console.error("Token validation error:",e),{success:!1,error:"VALIDATION_ERROR",message:"トークンの検証に失敗しました",details:e.message}}}getAuthState(){const e=this.getStoredToken(),s=this.getStoredUser();return{isAuthenticated:!!(e&&!this.isTokenExpired(e)),token:e,user:s}}setupAutoRefresh(e=50){if(typeof window>"u")return;const s=e*60*1e3;setInterval(async()=>{const t=this.getStoredToken();if(t&&!this.isTokenExpired(t))try{const r=JSON.parse(atob(t.split(".")[1])),n=Math.floor(Date.now()/1e3);r.exp-n<600&&await this.refreshToken()}catch(r){console.error("Auto refresh error:",r)}},s)}}const G=new vt;typeof window<"u"&&(G.initializeAuth(),G.setupAutoRefresh());const V={AUTH_TOKEN:"tournament_auth_token",USER_DATA:"tournament_user_data"};function Ue(i,e){try{const s=JSON.stringify(e);return localStorage.setItem(i,s),!0}catch(s){return console.error("Failed to save to localStorage:",s),!1}}function ze(i,e=null){try{const s=localStorage.getItem(i);return s===null?e:JSON.parse(s)}catch(s){return console.error("Failed to get from localStorage:",s),e}}function De(i){try{return localStorage.removeItem(i),!0}catch(e){return console.error("Failed to remove from localStorage:",e),!1}}function Oe(i){return Ue(V.AUTH_TOKEN,i)}function _e(){return ze(V.AUTH_TOKEN)}function ft(){return De(V.AUTH_TOKEN)}function Le(i){return Ue(V.USER_DATA,i)}function Ne(){return ze(V.USER_DATA)}function ht(){return De(V.USER_DATA)}function J(){ft(),ht()}const N={isAuthenticated:!1,token:null,user:null,loading:!1};function gt(){const{subscribe:i,set:e,update:s}=Ve(N);return{subscribe:i,setLoading:t=>{s(r=>({...r,loading:t}))},setAuthState:t=>{s(r=>({...r,isAuthenticated:!!t.token,token:t.token,user:t.user,loading:!1}))},clearAuth:()=>{e({...N})},login:async t=>{s(r=>({...r,loading:!0}));try{const r=await G.login(t.username,t.password);if(r.success){const n={token:r.data.token,user:r.data.user};return Oe(r.data.token),Le(r.data.user),s(d=>({...d,isAuthenticated:!0,token:r.data.token,user:r.data.user,loading:!1})),r}else return s(n=>({...n,loading:!1})),r}catch(r){return console.error("Login error in store:",r),s(n=>({...n,loading:!1})),{success:!1,error:"LOGIN_STORE_ERROR",message:"ログイン処理でエラーが発生しました",details:r.message}}},logout:async()=>{s(t=>({...t,loading:!0}));try{const t=await G.logout();return J(),e({...N}),t}catch(t){return console.error("Logout error in store:",t),J(),e({...N}),{success:!0,message:"ログアウトしました",warning:"サーバーとの通信でエラーが発生しましたが、ローカルの認証情報はクリアされました"}}},checkAuthStatus:async()=>{s(t=>({...t,loading:!0}));try{const t=_e(),r=Ne();if(!t)return s(d=>({...d,loading:!1})),{success:!1,error:"NO_TOKEN",message:"トークンが見つかりません"};const n=await G.validateToken();return n.success?(s(d=>({...d,isAuthenticated:!0,token:t,user:n.data?.user||r,loading:!1})),n):(J(),e({...N}),n)}catch(t){return console.error("Auth status check error in store:",t),J(),e({...N}),{success:!1,error:"AUTH_CHECK_ERROR",message:"認証状態の確認でエラーが発生しました",details:t.message}}},refreshToken:async()=>{if(Ye({subscribe:i}).loading)return{success:!1,error:"ALREADY_LOADING",message:"既に処理中です"};s(r=>({...r,loading:!0}));try{const r=await G.refreshToken();if(r.success){const n={token:r.data.token,user:r.data.user};return Oe(r.data.token),Le(r.data.user),s(d=>({...d,isAuthenticated:!0,token:r.data.token,user:r.data.user,loading:!1})),r}else return J(),e({...N}),r}catch(r){return console.error("Token refresh error in store:",r),J(),e({...N}),{success:!1,error:"REFRESH_STORE_ERROR",message:"トークンの更新でエラーが発生しました",details:r.message}}},initialize:async function(){const t=_e(),r=Ne();t&&r&&await this.checkAuthStatus()}}}const P=gt();typeof window<"u"&&(P.initialize(),window.addEventListener("auth:logout",()=>{P.clearAuth()}),document.addEventListener("visibilitychange",()=>{document.hidden||_e()&&P.checkAuthStatus()}));var kt=ce('<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>'),mt=ce('<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>'),_t=ce('<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>'),pt=ce('<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'),bt=S('<button class="toast-close svelte-trunga" aria-label="通知を閉じる" type="button"><svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>'),yt=S('<div role="alert" aria-live="polite" aria-atomic="true"><div class="toast-content svelte-trunga"><div class="toast-icon svelte-trunga"><!></div> <div class="toast-message svelte-trunga"> </div> <!></div></div>');function St(i,e){Ie(e,!1);let s=le(e,"message",8,""),t=le(e,"type",8,"info"),r=le(e,"duration",8,5e3),n=le(e,"dismissible",8,!0);const d=Qe();let h=q(!0),A;r()>0&&(A=setTimeout(()=>{k()},r()));function k(){B(h,!1),A&&clearTimeout(A),d("close")}let Y=q();xe();var $=ke(),K=Z($);{var ue=Q=>{var _=yt(),D=u(_),x=u(D),W=u(x);{var ee=g=>{var p=kt();f(g,p)},X=g=>{var p=ke(),re=Z(p);{var se=E=>{var H=mt();f(E,H)},ae=E=>{var H=ke(),oe=Z(H);{var fe=T=>{var j=_t();f(T,j)},he=T=>{var j=pt();f(T,j)};w(oe,T=>{t()==="warning"?T(fe):T(he,!1)},!0)}f(E,H)};w(re,E=>{t()==="error"?E(se):E(ae,!1)},!0)}f(g,p)};w(W,g=>{t()==="success"?g(ee):g(X,!1)})}c(x);var M=v(x,2),te=u(M,!0);c(M);var de=v(M,2);{var ve=g=>{var p=bt();I("click",p,k),f(g,p)};w(de,g=>{n()&&g(ve)})}c(D),c(_),lt(_,g=>B(Y,g),()=>o(Y)),z(()=>{y(_,1,`toast toast-${t()??""}`,"svelte-trunga"),We(te,s())}),f(Q,_)};w(K,Q=>{o(h)&&Q(ue)})}f(i,$),Ke()}var Tt=S('<a href="/admin">管理ダッシュボード</a> <button class="nav-button logout-button svelte-ikcr39">ログアウト</button>',1),wt=S('<a href="/login">管理者ログイン</a>'),At=S('<a href="/admin">管理ダッシュボード</a> <button class="mobile-nav-button logout-button svelte-ikcr39">ログアウト</button>',1),Et=S('<a href="/login">管理者ログイン</a>'),Rt=S('<div><div class="mobile-nav-content svelte-ikcr39"><a href="/">ホーム</a> <!></div></div>'),Ot=S('<li class="svelte-ikcr39"><a href="/admin" class="svelte-ikcr39">管理ダッシュボード</a></li>'),Lt=S('<li class="svelte-ikcr39"><a href="/login" class="svelte-ikcr39">管理者ログイン</a></li>'),Nt=S('<div class="loading-overlay svelte-ikcr39"><div class="loading-content svelte-ikcr39"><!> <p class="loading-text svelte-ikcr39">処理中...</p></div></div>'),It=S('<div class="app-layout svelte-ikcr39"><header class="header svelte-ikcr39"><div class="container"><nav class="navbar svelte-ikcr39"><div class="navbar-brand svelte-ikcr39"><a href="/" class="brand-link svelte-ikcr39"><h1 class="brand-title svelte-ikcr39">トーナメント管理</h1></a></div> <div class="navbar-nav desktop-nav svelte-ikcr39"><a href="/">ホーム</a> <!></div> <button class="mobile-menu-button svelte-ikcr39" aria-label="メニューを開く"><span></span> <span></span> <span></span></button></nav></div> <!></header> <main class="main-content svelte-ikcr39"><!></main> <footer class="footer svelte-ikcr39"><div class="container"><div class="footer-content svelte-ikcr39"><div class="footer-section svelte-ikcr39"><h3 class="footer-title svelte-ikcr39">トーナメント管理システム</h3> <p class="footer-description svelte-ikcr39">バレーボール、卓球、8人制サッカーのトーナメント管理</p></div> <div class="footer-section svelte-ikcr39"><h4 class="footer-subtitle svelte-ikcr39">リンク</h4> <ul class="footer-links svelte-ikcr39"><li class="svelte-ikcr39"><a href="/" class="svelte-ikcr39">ホーム</a></li> <!></ul></div></div> <div class="footer-bottom svelte-ikcr39"><p>&copy; 2024 トーナメント管理システム. All rights reserved.</p></div></div></footer> <!> <div class="notifications-container svelte-ikcr39"></div></div>');function Jt(i,e){Ie(e,!1);const[s,t]=et(),r=()=>me(P,"$authStore",s),n=()=>me(at,"$uiStore",s),d=()=>me(dt,"$page",s),h=q(),A=q();let k=q(!1);Xe(()=>{U.loadTheme(),P.initialize()});async function Y(){try{U.setLoading(!0);const a=await P.logout();a.success?(U.showNotification("ログアウトしました","success"),it("/")):U.showNotification(a.message||"ログアウトに失敗しました","error")}catch(a){console.error("Logout error:",a),U.showNotification("ログアウト処理でエラーが発生しました","error")}finally{U.setLoading(!1)}}function $(){B(k,!o(k))}function K(){B(k,!1)}function ue(a){U.removeNotification(a)}function Q(a){a.key==="Escape"&&o(k)&&K()}function _(a){return d().url.pathname===a}Ee(()=>r(),()=>{B(h,r())}),Ee(()=>n(),()=>{B(A,n())}),Ze(),xe();var D=It();I("keydown",$e,Q);var x=u(D),W=u(x),ee=u(W),X=v(u(ee),2),M=u(X);let te;var de=v(M,2);{var ve=a=>{var l=Tt(),m=Z(l);let b;var C=v(m,2);z(ne=>{b=y(m,1,"nav-link svelte-ikcr39",null,b,ne),C.disabled=(o(h),R(()=>o(h).loading))},[()=>({active:_("/admin")})]),I("click",C,Y),f(a,l)},g=a=>{var l=wt();let m;z(b=>m=y(l,1,"nav-link login-link svelte-ikcr39",null,m,b),[()=>({active:_("/login")})]),f(a,l)};w(de,a=>{o(h),R(()=>o(h).isAuthenticated)?a(ve):a(g,!1)})}c(X);var p=v(X,2),re=u(p);let se;var ae=v(re,2);let E;var H=v(ae,2);let oe;c(p),c(ee),c(W);var fe=v(W,2);{var he=a=>{var l=Rt();let m;var b=u(l),C=u(b);let ne;var Je=v(C,2);{var Be=O=>{var L=At(),F=Z(L);let ie;var Ae=v(F,2);z(Pe=>{ie=y(F,1,"mobile-nav-link svelte-ikcr39",null,ie,Pe),Ae.disabled=(o(h),R(()=>o(h).loading))},[()=>({active:_("/admin")})]),I("click",F,K),I("click",Ae,()=>{Y(),K()}),f(O,L)},Ge=O=>{var L=Et();let F;z(ie=>F=y(L,1,"mobile-nav-link login-link svelte-ikcr39",null,F,ie),[()=>({active:_("/login")})]),I("click",L,K),f(O,L)};w(Je,O=>{o(h),R(()=>o(h).isAuthenticated)?O(Be):O(Ge,!1)})}c(b),c(l),z((O,L)=>{m=y(l,1,"mobile-nav svelte-ikcr39",null,m,O),ne=y(C,1,"mobile-nav-link svelte-ikcr39",null,ne,L)},[()=>({open:o(k)}),()=>({active:_("/")})]),I("click",C,K),f(a,l)};w(fe,a=>{o(k)&&a(he)})}c(x);var T=v(x,2),j=u(T);ct(j,e,"default",{}),c(T);var ge=v(T,2),pe=u(ge),be=u(pe),ye=v(u(be),2),Se=v(u(ye),2),Me=v(u(Se),2);{var He=a=>{var l=Ot();f(a,l)},Ce=a=>{var l=Lt();f(a,l)};w(Me,a=>{o(h),R(()=>o(h).isAuthenticated)?a(He):a(Ce,!1)})}c(Se),c(ye),c(be),Re(2),c(pe),c(ge);var Te=v(ge,2);{var Fe=a=>{var l=Nt(),m=u(l),b=u(m);ot(b,{size:"large"}),Re(2),c(m),c(l),f(a,l)};w(Te,a=>{o(A),o(h),R(()=>o(A).loading||o(h).loading)&&a(Fe)})}var we=v(Te,2);rt(we,5,()=>(o(A),R(()=>o(A).notifications)),a=>a.id,(a,l)=>{St(a,{get message(){return o(l),R(()=>o(l).message)},get type(){return o(l),R(()=>o(l).type)},duration:0,$$events:{close:()=>ue(o(l).id)}})}),c(we),c(D),z((a,l,m,b)=>{te=y(M,1,"nav-link svelte-ikcr39",null,te,a),st(p,"aria-expanded",o(k)),se=y(re,1,"hamburger-line svelte-ikcr39",null,se,l),E=y(ae,1,"hamburger-line svelte-ikcr39",null,E,m),oe=y(H,1,"hamburger-line svelte-ikcr39",null,oe,b)},[()=>({active:_("/")}),()=>({open:o(k)}),()=>({open:o(k)}),()=>({open:o(k)})]),I("click",p,$),f(i,D),Ke(),t()}export{Jt as component};
