import{r as e,a as s}from"../chunks/CmSD4Lw8.js";import"../chunks/Cm9PB-7n.js";import{i as r}from"../chunks/B-6MdqlE.js";import{z as a,K as t,L as n,A as o,M as i,C as l,v as m,N as u,D as d,F as v,$ as p,I as c,G as g,J as b,u as w,O as f,H as _,P as h,w as E,Q as I,R as T,B as k,T as y}from"../chunks/VVabkdHj.js";import{p as O,i as S}from"../chunks/BSkGyvYi.js";import{s as A,a as D,b as L,r as j}from"../chunks/JJD-QFX9.js";import{b as N}from"../chunks/BCfgoF3A.js";import{g as P}from"../chunks/BRsi0Z70.js";import{d as R,v as x}from"../chunks/KE2xTBgs.js";import{c as C,s as G,d as M}from"../chunks/DoIqPyr3.js";const z=Object.freeze(Object.defineProperty({__proto__:null,load:async function({url:s}){return e(s,{redirectTo:"/admin",checkExpired:!0}),{errorType:s.searchParams.get("expired")?"expired":s.searchParams.get("invalid")?"invalid":s.searchParams.get("unauthorized")?"unauthorized":s.searchParams.get("network_error")?"network_error":s.searchParams.get("logout_error")?"logout_error":s.searchParams.get("session_expired")?"session_expired":s.searchParams.get("error")?"error":null,redirectTarget:s.searchParams.get("redirect")}}},Symbol.toStringTag,{value:"Module"}));var F=o('<div class="alert alert-error svelte-m98b94" role="alert"> </div>'),U=o('<div class="alert alert-success svelte-m98b94" role="alert"> </div>'),q=o('<div class="alert alert-warning svelte-m98b94" role="alert"> </div>'),K=o('<span class="error-message svelte-m98b94"> </span>'),V=o('<span class="error-message svelte-m98b94"> </span>'),$=o('<span class="loading-spinner svelte-m98b94"></span> ログイン中...',1),H=o('<div class="loading-overlay svelte-m98b94"><div class="loading-content svelte-m98b94"><span class="loading-spinner large svelte-m98b94"></span> <p class="svelte-m98b94">認証中...</p></div></div>'),B=o('<div class="login-container svelte-m98b94"><div class="login-card svelte-m98b94"><h1 class="svelte-m98b94">管理者ログイン</h1> <p class="login-description svelte-m98b94">トーナメント管理システムの管理者ダッシュボードにアクセスするには、認証情報を入力してください。</p> <!> <!> <!> <form novalidate="" class="svelte-m98b94"><div class="form-group svelte-m98b94"><label for="username">ユーザー名</label> <input type="text" id="username" name="username" autocomplete="username" data-testid="username" required/> <!></div> <div class="form-group svelte-m98b94"><label for="password">パスワード</label> <div class="password-input-container svelte-m98b94"><input id="password" name="password" autocomplete="current-password" data-testid="password" required/> <button type="button" class="password-toggle svelte-m98b94"> </button></div> <!></div> <input type="hidden" name="csrf_token" class="svelte-m98b94"/> <button type="submit" class="login-button svelte-m98b94" data-testid="login-button"><!></button></form> <!></div></div>');function J(e,o){a(o,!1);let z=O(o,"data",8),J=f({username:"",password:""}),Q=f({}),X=f(!1),W=f(!1),Y=0,Z=f(!1),ee=f(""),se=f(""),re=f(""),ae=f({});s.subscribe(e=>{t(ae,e)}),n(()=>{var e;if(t(ee,C.getToken()),z().errorType&&(e=z().errorType,t(se,{expired:"セッションの有効期限が切れました。再度ログインしてください。",invalid:"トークンが無効です。再度ログインしてください。",unauthorized:"アクセス権限がありません。",network_error:"ネットワークエラーが発生しました。",logout_error:"ログアウト処理でエラーが発生しましたが、認証情報はクリアされました。",session_expired:"セッションが期限切れになりました。",error:"エラーが発生しました。再度お試しください。"}[e]||"エラーが発生しました。"),G.logEvent("LOGIN_PAGE_ERROR",{errorType:e,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})),m(ae).isAuthenticated){const e=z().redirectTarget||"/admin";P(e)}});const te=R(e=>{const s=x(m(J).username,m(J).password);s.errors[e]?h(Q,m(Q)[e]=s.errors[e]):delete m(Q)[e],t(Q,{...m(Q)})},300);function ne(e){te(e)}async function oe(e){if(e.preventDefault(),m(X))return;const r=`login_${m(J).username||"anonymous"}`;if(!M.isAllowed(r))return t(Z,!0),t(se,"ログイン試行回数が上限に達しました。しばらく待ってから再試行してください。"),void G.logEvent("RATE_LIMIT_EXCEEDED",{username:m(J).username,attempts:Y,clientId:r});const a=x(m(J).username,m(J).password);if(!a.isValid)return t(Q,a.errors),t(se,"入力内容を確認してください"),void G.logEvent("LOGIN_VALIDATION_FAILED",{username:m(J).username,errors:a.errors});t(Q,{}),t(se,""),t(X,!0),Y++;try{const e={username:a.sanitizedData.username,password:a.sanitizedData.password,csrfToken:m(ee)};G.logEvent("LOGIN_ATTEMPT",{username:e.username,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent});const r=await s.login(e);if(r.success){t(re,"ログインに成功しました"),Y=0,G.logEvent("LOGIN_SUCCESS",{username:e.username,timestamp:(new Date).toISOString()});const s=z().redirectTarget||"/admin";setTimeout(()=>{P(s)},1e3)}else{let s="ログインに失敗しました";"INVALID_CREDENTIALS"===r.error?s="ユーザー名またはパスワードが正しくありません":"ACCOUNT_LOCKED"===r.error?s="アカウントがロックされています":"CSRF_TOKEN_MISMATCH"===r.error?(s="セキュリティトークンが無効です。ページを再読み込みしてください。",t(ee,C.refreshToken())):r.message&&(s=r.message),t(se,s),G.logEvent("LOGIN_FAILED",{username:e.username,error:r.error,attempts:Y,timestamp:(new Date).toISOString()}),h(J,m(J).password=""),Y>=3&&G.logEvent("MULTIPLE_LOGIN_FAILURES",{username:e.username,attempts:Y,timestamp:(new Date).toISOString()})}}catch(n){t(se,"ログイン処理でエラーが発生しました"),G.logEvent("LOGIN_ERROR",{username:m(J).username,error:n.message,attempts:Y,timestamp:(new Date).toISOString()}),h(J,m(J).password="")}finally{t(X,!1)}}function ie(e){"Enter"!==e.key||m(X)||oe(e)}r();var le=B();i(e=>{p.title="管理者ログイン - Tournament Management System"});var me=g(le),ue=c(g(me),4),de=e=>{var s=F(),r=g(s,!0);_(s),l(()=>b(r,m(se))),d(e,s)};S(ue,e=>{m(se)&&e(de)});var ve=c(ue,2),pe=e=>{var s=U(),r=g(s,!0);_(s),l(()=>b(r,m(re))),d(e,s)};S(ve,e=>{m(re)&&e(pe)});var ce=c(ve,2),ge=e=>{var s=q(),r=g(s);_(s),l(e=>b(r,`セキュリティのため、ログイン試行が一時的に制限されています。\n        残り試行回数: ${e??""}`),[()=>(E(M),m(J),w(()=>M.getRemainingRequests(m(J).username||"anonymous")))]),d(e,s)};S(ce,e=>{m(Z)&&e(ge)});var be=c(ce,2),we=g(be),fe=g(we);let _e;var he=c(fe,2);let Ee;j(he);var Ie=c(he,2),Te=e=>{var s=K(),r=g(s,!0);_(s),l(()=>b(r,(m(Q),w(()=>m(Q).username)))),d(e,s)};S(Ie,e=>{m(Q),w(()=>m(Q).username)&&e(Te)}),_(we);var ke=c(we,2),ye=g(ke);let Oe;var Se=c(ye,2),Ae=g(Se);let De;j(Ae);var Le=c(Ae,2),je=g(Le,!0);_(Le),_(Se);var Ne=c(Se,2),Pe=e=>{var s=V(),r=g(s,!0);_(s),l(()=>b(r,(m(Q),w(()=>m(Q).password)))),d(e,s)};S(Ne,e=>{m(Q),w(()=>m(Q).password)&&e(Pe)}),_(ke);var Re=c(ke,2);j(Re);var xe=c(Re,2),Ce=g(xe),Ge=e=>{var s=$();I(),d(e,s)},Me=e=>{var s=T(),r=k(s),a=e=>{var s=y("制限中");d(e,s)},t=e=>{var s=y("ログイン");d(e,s)};S(r,e=>{m(Z)?e(a):e(t,!1)},!0),d(e,s)};S(Ce,e=>{m(X),m(ae),w(()=>m(X)||m(ae).loading)?e(Ge):e(Me,!1)}),_(xe),_(be);var ze=c(be,2),Fe=e=>{var s=H();d(e,s)};S(ze,e=>{m(ae),w(()=>m(ae).loading)&&e(Fe)}),_(me),_(le),l((e,s,r,a)=>{_e=A(fe,1,"svelte-m98b94",null,_e,e),he.disabled=m(X),Ee=A(he,1,"svelte-m98b94",null,Ee,s),Oe=A(ye,1,"svelte-m98b94",null,Oe,r),D(Ae,"type",m(W)?"text":"password"),Ae.disabled=m(X),De=A(Ae,1,"svelte-m98b94",null,De,a),Le.disabled=m(X),D(Le,"aria-label",m(W)?"パスワードを隠す":"パスワードを表示"),b(je,m(W)?"🙈":"👁️"),L(Re,m(ee)),xe.disabled=(m(X),m(ae),m(Z),w(()=>m(X)||m(ae).loading||m(Z)))},[()=>({error:m(Q).username}),()=>({error:m(Q).username}),()=>({error:m(Q).password}),()=>({error:m(Q).password})]),N(he,()=>m(J).username,e=>h(J,m(J).username=e)),u("blur",he,()=>ne("username")),u("input",he,()=>ne("username")),u("keydown",he,ie),N(Ae,()=>m(J).password,e=>h(J,m(J).password=e)),u("blur",Ae,()=>ne("password")),u("input",Ae,()=>ne("password")),u("keydown",Ae,ie),u("click",Le,function(){t(W,!m(W))}),u("submit",be,oe),d(e,le),v()}export{J as component,z as universal};
